// Code generated by deepcopy-gen. DO NOT EDIT.

package api

import (
	model "go-common/app/service/main/member/model"
)

// DeepCopyInto is an autogenerated deepcopy function, copying the receiver, writing into out. in must be non-nil.
func (in *LevelInfo) DeepCopyInto(out *LevelInfo) {
	*out = *in
	return
}

// DeepCopy is an autogenerated deepcopy function, copying the receiver, creating a new LevelInfo.
func (in *LevelInfo) DeepCopy() *LevelInfo {
	if in == nil {
		return nil
	}
	out := new(LevelInfo)
	in.DeepCopyInto(out)
	return out
}

// DeepCopyAsIntoLevelInfo is an autogenerated deepcopy function, copying the receiver, writing into model.LevelInfo.
func (in *LevelInfo) DeepCopyAsIntoLevelInfo(out *model.LevelInfo) {
	out.Cur = in.Cur
	out.Min = in.Min
	out.NowExp = in.NowExp
	out.NextExp = in.NextExp
	return
}

// DeepCopyFromLevelInfo is an autogenerated deepcopy function, copying the receiver, writing into model.LevelInfo.
func (out *LevelInfo) DeepCopyFromLevelInfo(in *model.LevelInfo) {
	out.Cur = in.Cur
	out.Min = in.Min
	out.NowExp = in.NowExp
	out.NextExp = in.NextExp
	return
}

// DeepCopyAsLevelInfo is an autogenerated deepcopy function, copying the receiver, creating a new model.LevelInfo.
func (in *LevelInfo) DeepCopyAsLevelInfo() *model.LevelInfo {
	if in == nil {
		return nil
	}
	out := new(model.LevelInfo)
	in.DeepCopyAsIntoLevelInfo(out)
	return out
}

// DeepCopyInto is an autogenerated deepcopy function, copying the receiver, writing into out. in must be non-nil.
func (in *OfficialInfo) DeepCopyInto(out *OfficialInfo) {
	*out = *in
	return
}

// DeepCopy is an autogenerated deepcopy function, copying the receiver, creating a new OfficialInfo.
func (in *OfficialInfo) DeepCopy() *OfficialInfo {
	if in == nil {
		return nil
	}
	out := new(OfficialInfo)
	in.DeepCopyInto(out)
	return out
}

// DeepCopyAsIntoOfficialInfo is an autogenerated deepcopy function, copying the receiver, writing into model.OfficialInfo.
func (in *OfficialInfo) DeepCopyAsIntoOfficialInfo(out *model.OfficialInfo) {
	out.Role = in.Role
	out.Title = in.Title
	out.Desc = in.Desc
	return
}

// DeepCopyFromOfficialInfo is an autogenerated deepcopy function, copying the receiver, writing into model.OfficialInfo.
func (out *OfficialInfo) DeepCopyFromOfficialInfo(in *model.OfficialInfo) {
	out.Role = in.Role
	out.Title = in.Title
	out.Desc = in.Desc
	return
}

// DeepCopyAsOfficialInfo is an autogenerated deepcopy function, copying the receiver, creating a new model.OfficialInfo.
func (in *OfficialInfo) DeepCopyAsOfficialInfo() *model.OfficialInfo {
	if in == nil {
		return nil
	}
	out := new(model.OfficialInfo)
	in.DeepCopyAsIntoOfficialInfo(out)
	return out
}

// DeepCopyInto is an autogenerated deepcopy function, copying the receiver, writing into out. in must be non-nil.
func (in *VipReply) DeepCopyInto(out *VipReply) {
	*out = *in
	return
}

// DeepCopy is an autogenerated deepcopy function, copying the receiver, creating a new VipReply.
func (in *VipReply) DeepCopy() *VipReply {
	if in == nil {
		return nil
	}
	out := new(VipReply)
	in.DeepCopyInto(out)
	return out
}

// DeepCopyAsIntoVipInfo is an autogenerated deepcopy function, copying the receiver, writing into VipInfo.
func (in *VipReply) DeepCopyAsIntoVipInfo(out *VipInfo) {
	out.Type = in.Type
	out.Status = in.Status
	out.DueDate = in.DueDate
	out.VipPayType = in.VipPayType
	return
}

// DeepCopyFromVipInfo is an autogenerated deepcopy function, copying the receiver, writing into VipInfo.
func (out *VipReply) DeepCopyFromVipInfo(in *VipInfo) {
	out.Type = in.Type
	out.Status = in.Status
	out.DueDate = in.DueDate
	out.VipPayType = in.VipPayType
	return
}

// DeepCopyAsVipInfo is an autogenerated deepcopy function, copying the receiver, creating a new VipInfo.
func (in *VipReply) DeepCopyAsVipInfo() *VipInfo {
	if in == nil {
		return nil
	}
	out := new(VipInfo)
	in.DeepCopyAsIntoVipInfo(out)
	return out
}
